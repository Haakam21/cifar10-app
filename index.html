<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <title>CIFAR-10 App</title>
  </head>
  <body class="w-75 mx-auto p-2">
    <h1>CIFAR-10 App</h1>
    <p>Upload an image to be classified within one of the following classes.</p>
    <h5 class="mb-2">Classes: <span id="classes"></span></h5>
    <img class="img-fluid mb-2" id="preview" alt="upload image"/>
    <div class="input-group w-auto mb-2">
      <div class="custom-file">
        <input type="file" class="custom-file-input" id="imageInput" aria-describedby="imageInput">
        <label class="custom-file-label" for="imageInput">Choose file</label>
      </div>
    </div>
    <div id="prediction">
      <h3>Prediction: <span></span></h3>
      <p>Probabilities: <span></span></p>
    </div>
    <div id="predictions">
      <h5 class="mb-2">Recent predictions:</h5>
      <div></div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script>
      var image_width = 32
      var image_height = 32

      var classes = ['airplane', 'automobile', 'bird', 'cat', 'deer', 'dog', 'frog', 'horse', 'ship', 'truck']


      function percentage(num) {
        return Math.round(num * 10000) / 100 + '%'
      }

      function maxIndexValue(array) {
        var maxValue = array[0]
        var maxIndex = 0
        for (var i = 1; i < array.length; i++) {
            if (array[i] > maxValue) {
                maxIndex = i
                maxValue = array[i]
            }
        }
        return [maxIndex, maxValue]
      }

      var shapeImageData = function(data, width, height) {
        var imageData = []
        for (i = 0; i < height; i++) {
          var row = []
          for (j = 0; j < width; j++) {
            row[j] = [data[4 * (width * i + j)], data[4 * (width * i + j) + 1], data[4 * (width * i + j) + 2]]
          }
          imageData[i] = row
        }
        return imageData
      }

      var unshapeImageData = function(data, width, height) {
        imageData = new Uint8ClampedArray(width * height * 4)
        for (var i = 0; i < height; i++) {
          for (var j = 0; j < width; j++) {
              var pos = (i * width + j) * 4
              imageData[pos ] = data[i][j][0]
              imageData[pos + 1] = data[i][j][1]
              imageData[pos + 2] = data[i][j][2]
              imageData[pos + 3] = 255
          }
        }
        return imageData
      }

      var handlePredictionsResponse = function(response) {
        console.log(response)

        for (var i = 0; i < response.length; i++)  {
          var canvas = document.createElement('canvas')
          canvas.width = image_width
          canvas.height = image_height
          var ctx = canvas.getContext('2d')

          var imageData = ctx.createImageData(image_width, image_height)
          imageData.data.set(unshapeImageData(response[i].image, image_width, image_height))
          ctx.putImageData(imageData, 0, 0)

          $(canvas).attr('data-toggle', 'tooltip')
          $(canvas).attr('data-placement', 'bottom')
          var max = maxIndexValue(response[i].prediction)
          $(canvas).attr('title', classes[max[0]] + ' (' + percentage(max[1])+ ')')
          $('#predictions div').append(canvas)
        }

        $('[data-toggle="tooltip"]').tooltip()
      }

      var handlePredictResponse = function(response) {
        console.log(response)

        predictions = response.predictions[0]
        var max = maxIndexValue(predictions)
        $('#prediction h3 span').text(classes[max[0]] + ' (' + percentage(max[1])+ ')')

        var probabilities = []
        for (var i = 0; i < classes.length; i++) {
            probabilities[i] = classes[i] + ': ' + percentage(predictions[i])
        }
        $('#prediction p span').text(probabilities.join(', '))
      }


      var predict = function(image) {
        var canvas = document.createElement('canvas')
        canvas.width = image_width
        canvas.height = image_height
        var ctx = canvas.getContext('2d')

        ctx.drawImage(image, 0, 0, image_width, image_height)
        var canvasData = ctx.getImageData(0, 0, image_width, image_height).data
        var imageData = shapeImageData(canvasData, image_width, image_height)

        jsonData = {'instances': [imageData]}

        $.ajax({
          method: 'post',
          url: '/predict',
          data: JSON.stringify(jsonData),
          dataType: 'json',
          contentType: 'application/json',
          success: handlePredictResponse,
          cache: false
        })
      }

      $(document).ready(function() {
        $('#classes').text(classes.join(', '))
        document.getElementById('preview').src = 'airplane.png'

        var image = document.getElementById('preview')
        image.onload = function (imageEvent) {
          predict(image)
        }

        $.ajax({
          method: 'get',
          url: '/predictions',
          contentType: 'application/json',
          success: handlePredictionsResponse
        })
      })

      $('#imageInput').on('change', function(){
        var file = this.files[0]
        if (file) {
          document.getElementById('preview').src = window.URL.createObjectURL(file)

          var reader = new FileReader()
          reader.onload = function (readerEvent) {
            var image = new Image()
            image.onload = function (imageEvent) {
              predict(image)
            }
            image.src = readerEvent.target.result
          }
          reader.readAsDataURL(file)
        }
      })
    </script>
  </body>
</html>
