<!DOCTYPE html>
<html>
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
<h1>CIFAR-10 App</h1>

<h3 id="classes"></h3>
<img id="preview" alt="upload image" height=400/>
<input id="image_input" type="file" accept="image/*">
<h2 id="prediction"></h2>
<p id="probabilities"></p>

<script>
  var image_width = 32
  var image_height = 32

  var classes = ['airplane', 'automobile', 'bird', 'cat', 'deer', 'dog', 'frog', 'horse', 'ship', 'truck']


  var reshapeImageData = function(data, width, height) {
    var imageData = []
    for (i = 0; i < height; i++) {
      var row = []
      for (j = 0; j < width; j++) {
        row[j] = [data[4 * (width * i + j)], data[4 * (width * i + j) + 1], data[4 * (width * i + j) + 2]]
      }
      imageData[i] = row
    }
    console.log(imageData)
    return imageData
  }

  function maxIndexValue(array) {
    var maxValue = array[0]
    var maxIndex = 0
    for (var i = 1; i < array.length; i++) {
        if (array[i] > maxValue) {
            maxIndex = i
            maxValue = array[i]
        }
    }
    return [maxIndex, maxValue]
  }

  function percentage(num) {
    return Math.round(num * 10000) / 100 + '%'
  }

  var handleResponse = function(response) {
    console.log(response)
    predictions = response.predictions[0]
    var max = maxIndexValue(predictions)
    $('#prediction').text('prediction: ' + classes[max[0]] + ' (' + percentage(max[1])+ ')')
    var probabilities = 'probabilities: '
    for (var i = 0; i < classes.length; i++) {
        probabilities += classes[i] + ': ' + percentage(predictions[i])
        if (i < classes.length - 1) {
          probabilities += ', '
        }
    }
    $('#probabilities').text(probabilities)
  }


  $(document).ready(function() {
    $('#classes').text('classes: ' + classes.join(', '))
  });

  $('#image_input').on('change', function(){
    var file = this.files[0]

    $('#preview').attr('src', window.URL.createObjectURL(file))

    var reader = new FileReader()
    reader.onload = function (readerEvent) {
      var image = new Image()
      image.onload = function (imageEvent) {
        var canvas = document.createElement('canvas')
        var ctx = canvas.getContext('2d')

        ctx.drawImage(image, 0, 0, image_width, image_height)
        var canvasData = ctx.getImageData(0, 0, image_width, image_height).data
        var imageData = reshapeImageData(canvasData, image_width, image_height)

        jsonData = {'instances': [imageData]}

        $.ajax({
          method: 'post',
          url: '/',
          data: JSON.stringify(jsonData),
          dataType: 'json',
          contentType: 'application/json',
          success: handleResponse,
          cache: false
        })
      }
      image.src = readerEvent.target.result
    }
    reader.readAsDataURL(file)
  })
</script>
</body>
</html>
